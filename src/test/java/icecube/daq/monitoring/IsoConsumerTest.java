package icecube.daq.monitoring;

import icecube.daq.rapcal.Isochron;
import icecube.daq.rapcal.RAPCalException;
import icecube.daq.util.DOMInfo;
import org.junit.Before;
import org.junit.Test;
import static org.junit.Assert.*;

/**
 * Tests RunMonitor.IsochronConsumer
 */
public class IsoConsumerTest
{

    /**
     * An actual set of tcals captured from Graphaphobia which includes
     * a wild tcal within the first 5 samples.
     */
    long[][] TCAL_SEQUENCE = new long[][]
            {
                    { 70205509997957000L, 4935337905651302L, 4935337905808250L, 70205509998437743L },   // clen: 0.0000161897
                    { 70205700634864000L, 4935528542398892L, 4935528542555750L, 70205700635344702L },   // clen: 0.0000161922
            /*WILD*/{ 70205746817148000L, 4935574724621995L, 4935574724776250L, 70205746817603844L },   // clen: 0.0000150794 // WILD!
                    { 70205757443421500L, 4935585350908856L, 4935585351065750L, 70205757443902212L },   // clen: 0.0000161909
                    { 70205769853402500L, 4935597760879453L, 4935597761036250L, 70205769853883089L },   // clen: 0.0000161896
                    { 70205843835625500L, 4935671743040574L, 4935671743197250L, 70205843836106000L },   // clen: 0.0000161912
                    { 70206078474832500L, 4935906382051324L, 4935906382207750L, 70206078475312750L },   // clen: 0.0000161912
                    { 70206248278331000L, 4936076185407778L, 4936076185564250L, 70206248278811282L },   // clen: 0.0000161905
                    { 70206270305094000L, 4936098212152346L, 4936098212308750L, 70206270305574223L },   // clen: 0.0000161909
                    { 70206601977522500L, 4936429884303456L, 4936429884460250L, 70206601978003150L },   // clen: 0.0000161928
                    { 70206965970869000L, 4936793877345464L, 4936793877502750L, 70206965971350115L },   // clen: 0.0000161914
                    { 70207100115802500L, 4936928022166764L, 4936928022323250L, 70207100116282802L },   // clen: 0.0000161908
                    { 70207111262863500L, 4936939169218453L, 4936939169375250L, 70207111263344148L },   // clen: 0.0000161925
                    { 70207135808678000L, 4936963715012390L, 4936963715169250L, 70207135809158684L },   // clen: 0.0000161912
                    { 70207196075159500L, 4937023981443488L, 4937023981600250L, 70207196075640078L },   // clen: 0.0000161908
                    { 70207207514361000L, 4937035420635463L, 4937035420792250L, 70207207514841647L },   // clen: 0.0000161930
                    { 70207243253503000L, 4937071159747531L, 4937071159904250L, 70207243253983548L },   // clen: 0.0000161914
                    { 70207253562441500L, 4937081468677446L, 4937081468834250L, 70207253562922157L },   // clen: 0.0000161926
                    { 70207354170368500L, 4937182076520271L, 4937182076676750L, 70207354170848812L },   // clen: 0.0000161916
                    { 70207814833684000L, 4937642739450448L, 4937642739607250L, 70207814834164650L },   // clen: 0.0000161924
                    { 70207826933502500L, 4937654839258796L, 4937654839415250L, 70207826933982764L },   // clen: 0.0000161905
                    { 70207837726057000L, 4937665631804268L, 4937665631960750L, 70207837726537295L },   // clen: 0.0000161906
                    { 70208129695847500L, 4937957601350536L, 4937957601507250L, 70208129696328053L },   // clen: 0.0000161919
                    { 70208218013465000L, 4938045918894120L, 4938045919050750L, 70208218013945411L },   // clen: 0.0000161890
                    { 70208229648512500L, 4938057553931922L, 4938057554088750L, 70208229648993162L },   // clen: 0.0000161917
                    { 70208243021379500L, 4938070926787726L, 4938070926944250L, 70208243021859848L },   // clen: 0.0000161912
                    { 70208382378290000L, 4938210283581696L, 4938210283738250L, 70208382378770401L },   // clen: 0.0000161923
                    { 70208492096936000L, 4938320002135879L, 4938320002292750L, 70208492097416685L },   // clen: 0.0000161907
                    { 70208514927091500L, 4938342832272307L, 4938342832428750L, 70208514927571764L },   // clen: 0.0000161910
                    { 70208624604947000L, 4938452510036054L, 4938452510192750L, 70208624605427512L },   // clen: 0.0000161908
                    { 70209344918434000L, 4939172822920595L, 4939172823077250L, 70209344918914468L },   // clen: 0.0000161906
                    { 70209380536412000L, 4939208440868784L, 4939208441025750L, 70209380536892743L },   // clen: 0.0000161888
                    { 70209392076351000L, 4939219980798170L, 4939219980954750L, 70209392076831407L },   // clen: 0.0000161913
                    { 70209402698270500L, 4939230602708819L, 4939230602865250L, 70209402698750775L },   // clen: 0.0000161922
                    { 70209416454031500L, 4939244358458282L, 4939244358615250L, 70209416454512286L },   // clen: 0.0000161909
                    { 70209531250308000L, 4939359154638836L, 4939359154795250L, 70209531250788298L },   // clen: 0.0000161942
                    { 70209810303508500L, 4939638207605878L, 4939638207762250L, 70209810303988675L },   // clen: 0.0000161901
                    { 70209835292202500L, 4939663196279032L, 4939663196435250L, 70209835292682574L },   // clen: 0.0000161928
                    { 70209847647145500L, 4939675551211692L, 4939675551368750L, 70209847647626411L },   // clen: 0.0000161926
                    { 70209976338678000L, 4939804242636550L, 4939804242793250L, 70209976339158544L },   // clen: 0.0000161922
                    { 70209989090126000L, 4939816994073871L, 4939816994230250L, 70209989090606207L },   // clen: 0.0000161914
                    { 70210050587090500L, 4939878490986896L, 4939878491143750L, 70210050587571148L },   // clen: 0.0000161897
                    { 70210252823988500L, 4940080727715854L, 4940080727872250L, 70210252824468749L },   // clen: 0.0000161926
                    { 70210263835123000L, 4940091738841135L, 4940091738997750L, 70210263835603486L },   // clen: 0.0000161935
                    { 70210275478431000L, 4940103382139337L, 4940103382296250L, 70210275478911707L },   // clen: 0.0000161897
                    { 70210756576916000L, 4940584480222045L, 4940584480378750L, 70210756577396559L },   // clen: 0.0000161927
                    { 70210826782055500L, 4940654685302820L, 4940654685459250L, 70210826782535790L },   // clen: 0.0000161930
                    { 70210865970512000L, 4940693873726549L, 4940693873883250L, 70210865970992548L },   // clen: 0.0000161923
                    { 70211007566196500L, 4940835469292565L, 4940835469449250L, 70211007566677001L },   // clen: 0.0000161908
                    { 70211018720371500L, 4940846623458247L, 4940846623614750L, 70211018720851822L },   // clen: 0.0000161909
                    { 70211031683864000L, 4940859586939925L, 4940859587096750L, 70211031684344667L },   // clen: 0.0000161921
                    { 70211044086380500L, 4940871989446047L, 4940871989602750L, 70211044086861036L },   // clen: 0.0000161916
                    { 70211386739242000L, 4941214642020925L, 4941214642177750L, 70211386739722649L },   // clen: 0.0000161912
                    { 70211421544501500L, 4941249447251350L, 4941249447408250L, 70211421544982279L },   // clen: 0.0000161939
                    { 70211432246568000L, 4941260149308886L, 4941260149465750L, 70211432247048720L },   // clen: 0.0000161928
                    { 70211539793249500L, 4941367695900383L, 4941367696057250L, 70211539793730186L },   // clen: 0.0000161909
                    { 70211574793865000L, 4941402696486606L, 4941402696643250L, 70211574794345446L },   // clen: 0.0000161901
                    { 70211585865882500L, 4941413768494849L, 4941413768651250L, 70211585866362726L },   // clen: 0.0000161912
                    { 70211596198579500L, 4941424101183207L, 4941424101339750L, 70211596199059869L },   // clen: 0.0000161913
                    { 70211695781809000L, 4941523684329444L, 4941523684485750L, 70211695782289184L },   // clen: 0.0000161939
                    { 70212274448598000L, 4942102350634326L, 4942102350791250L, 70212274449078803L },   // clen: 0.0000161939
                    { 70212299647863000L, 4942127549878194L, 4942127550034750L, 70212299648343351L },   // clen: 0.0000161897
                    { 70212351405926500L, 4942179307898386L, 4942179308055250L, 70212351406407174L },   // clen: 0.0000161905
                    { 70212495581633500L, 4942323483484808L, 4942323483641250L, 70212495582113808L },   // clen: 0.0000161933
                    { 70212532532142500L, 4942360433962878L, 4942360434119250L, 70212532532622715L },   // clen: 0.0000161921
                    { 70212617769848500L, 4942445671597551L, 4942445671754250L, 70212617770329018L },   // clen: 0.0000161909
                    { 70212886581686500L, 4942714483210633L, 4942714483367250L, 70212886582166958L },   // clen: 0.0000161920
                    { 70212963167826500L, 4942791069286504L, 4942791069443250L, 70212963168307037L },   // clen: 0.0000161895
                    { 70213150873076000L, 4942978774378965L, 4942978774535750L, 70213150873556583L },   // clen: 0.0000161899
                    { 70213253999772000L, 4943081900988724L, 4943081901145250L, 70213254000252358L },   // clen: 0.0000161916
                    { 70213726149159000L, 4943554049980743L, 4943554050137250L, 70213726149639346L },   // clen: 0.0000161919
                    { 70213785357449500L, 4943613258221726L, 4943613258378250L, 70213785357929886L },   // clen: 0.0000161931
                    { 70213866137631500L, 4943694038336119L, 4943694038492750L, 70213866138111959L },   // clen: 0.0000161914
                    { 70214006498994000L, 4943834399581223L, 4943834399737750L, 70214006499474368L },   // clen: 0.0000161920
                    { 70214160140424000L, 4943988040882661L, 4943988041039250L, 70214160140904396L },   // clen: 0.0000161903
                    { 70214171048769500L, 4943998949219070L, 4943998949375750L, 70214171049250013L },   // clen: 0.0000161916
                    { 70214182182432500L, 4944010082872719L, 4944010083029250L, 70214182182912808L },   // clen: 0.0000161888
                    { 70214507853596500L, 4944335753764329L, 4944335753920750L, 70214507854076762L },   // clen: 0.0000161920
                    { 70214553704597000L, 4944381604726481L, 4944381604882750L, 70214553705077116L },   // clen: 0.0000161923
                    { 70214758665467500L, 4944586565425494L, 4944586565582250L, 70214758665948078L },   // clen: 0.0000161911
                    { 70214772858825500L, 4944600758771592L, 4944600758928250L, 70214772859305963L },   // clen: 0.0000161902
                    { 70214785023389500L, 4944612923325432L, 4944612923481750L, 70214785023869640L },   // clen: 0.0000161911
                    { 70214889253494000L, 4944717153342782L, 4944717153499250L, 70214889253974335L },   // clen: 0.0000161933
                    { 70214900412710500L, 4944728312549899L, 4944728312706750L, 70214900413191174L },   // clen: 0.0000161911
                    { 70214910695523500L, 4944738595354281L, 4944738595510750L, 70214910696003779L },   // clen: 0.0000161905
                    { 70215236790185000L, 4945064689743001L, 4945064689899750L, 70215236790665561L },   // clen: 0.0000161906
                    { 70215358902780500L, 4945186802236401L, 4945186802392750L, 70215358903260715L },   // clen: 0.0000161933
                    { 70215452278588000L, 4945280177965691L, 4945280178122250L, 70215452279068343L },   // clen: 0.0000161892
                    { 70215466906863000L, 4945294806228490L, 4945294806385250L, 70215466907343568L },   // clen: 0.0000161904
                    { 70215477316176000L, 4945305215532799L, 4945305215689750L, 70215477316656776L },   // clen: 0.0000161912
                    { 70215603017462500L, 4945430916714204L, 4945430916870750L, 70215603017942935L },   // clen: 0.0000161944
                    { 70215711143341000L, 4945539042502226L, 4945539042659250L, 70215711143821882L },   // clen: 0.0000161929
                    { 70216075013369500L, 4945902912226337L, 4945902912383250L, 70216075013850268L },   // clen: 0.0000161927
                    { 70216198475840500L, 4946026374594014L, 4946026374750750L, 70216198476321054L },   // clen: 0.0000161909
                    { 70216305152367000L, 4946133051031271L, 4946133051187750L, 70216305152847309L },   // clen: 0.0000161915
                    { 70216337742088500L, 4946165640725495L, 4946165640882250L, 70216337742569056L },   // clen: 0.0000161900
                    { 70216425146812000L, 4946253045375893L, 4946253045532750L, 70216425147292687L },   // clen: 0.0000161915
                    { 70216522674308500L, 4946350572790777L, 4946350572947750L, 70216522674789272L },   // clen: 0.0000161899
                    { 70216533426239000L, 4946361324712314L, 4946361324868750L, 70216533426719273L },   // clen: 0.0000161918
                    { 70216638575905500L, 4946466474290867L, 4946466474447250L, 70216638576385737L },   // clen: 0.0000161927
                    { 70216905344381500L, 4946733242543630L, 4946733242700750L, 70216905344862445L },   // clen: 0.0000161912
                    { 70217269687916500L, 4947097585773840L, 4947097585930750L, 70217269688397253L },   // clen: 0.0000161921
                    { 70217402081533500L, 4947229979280046L, 4947229979436750L, 70217402082014013L },   // clen: 0.0000161904
                    { 70217463632886000L, 4947291530581069L, 4947291530737750L, 70217463633366519L },   // clen: 0.0000161919
                    { 70217567947432000L, 4947395845039832L, 4947395845196250L, 70217567947912253L },   // clen: 0.0000161917
                    { 70217578881893500L, 4947406779492209L, 4947406779648750L, 70217578882373886L },   // clen: 0.0000161922
                    { 70217589692696500L, 4947417590286139L, 4947417590442750L, 70217589693176952L },   // clen: 0.0000161920
                    { 70218081266077000L, 4947909163255461L, 4947909163412250L, 70218081266557618L },   // clen: 0.0000161914
                    { 70218255231167500L, 4948083128200426L, 4948083128357250L, 70218255231648107L },   // clen: 0.0000161891
                    { 70218832688220500L, 4948660584770596L, 4948660584927250L, 70218832688701044L },   // clen: 0.0000161945
                    { 70218886247933000L, 4948714144438281L, 4948714144594750L, 70218886248413319L },   // clen: 0.0000161925
                    { 70218987625851000L, 4948815522271481L, 4948815522428250L, 70218987626331617L },   // clen: 0.0000161924
                    { 70218998170083000L, 4948826066494646L, 4948826066651250L, 70218998170563432L },   // clen: 0.0000161914
                    { 70219135290911500L, 4948963187208419L, 4948963187365250L, 70219135291392108L },   // clen: 0.0000161888
                    { 70219145722392500L, 4948973618680741L, 4948973618837750L, 70219145722873342L },   // clen: 0.0000161916
                    { 70219185485322500L, 4949013381577483L, 4949013381734250L, 70219185485803079L },   // clen: 0.0000161906
                    { 70219196914008000L, 4949024810253413L, 4949024810410250L, 70219196914488651L },   // clen: 0.0000161907
                    { 70219245304930000L, 4949073201134956L, 4949073201291750L, 70219245305410628L },   // clen: 0.0000161917
            /*WILD*/{ 70219331410618500L, 4949159306721856L, 4949159306876250L, 70219331411067136L },   // clen: 0.0000147121 // WILD!
                    { 70219832754322000L, 4949660650035586L, 4949660650192250L, 70219832754802491L },   // clen: 0.0000161913
                    { 70220074033880000L, 4949901929391775L, 4949901929548250L, 70220074034360285L },   // clen: 0.0000161905
                    { 70220084653934000L, 4949912549436895L, 4949912549593750L, 70220084654414676L },   // clen: 0.0000161910
            };

    Isochron[] isochrons;

    @Before
    public void setUp() throws RAPCalException
    {
        isochrons = new Isochron[TCAL_SEQUENCE.length - 1];
        for (int i = 1; i < TCAL_SEQUENCE.length; i++)
        {
            isochrons[i-1] =
                    new Isochron(TCAL_SEQUENCE[i - 1], TCAL_SEQUENCE[i], 0);
        }
    }

    @Test
    public void testWildTCalFiltering()
    {
        ///
        /// Tests that Cable history detects and filters wild cable lengths
        /// from contributing to the average
        ///

        DOMInfo dom = new DOMInfo(123, 11, 20);
        IsoConsumer dummy = new IsoConsumer(null);

        IsoConsumer.CableHisto cableHist = dummy.new CableHisto(dom);
        for (int i = 0; i < isochrons.length; i++)
        {
            cableHist.process(isochrons[i]);
        }

        assertEquals(1.6181049971325617E-5, cableHist.getMinValue(), 0.0);
        assertEquals(1.6201049971325617E-5, cableHist.getMaxValue(), 0.0);
        assertEquals(119, cableHist.getBinTotal());
        assertEquals(0, cableHist.getOverflow());
        assertEquals(2, cableHist.getUnderflow());
    }


}
